<div class="fixed inset-0 -z-10 gh-sky">
  <div class="absolute inset-0 gh-hills opacity-70"></div>
  <div class="absolute inset-0 gh-grain pointer-events-none"></div>
</div>

<div class="container mx-auto max-w-3xl px-4 md:px-8 py-8 md:py-12">
  <div class="mb-6">
    <%= link_to "← 戻る", passage_path(@passage), class: "link link-primary" %>
  </div>

  <div class="rounded-3xl gh-glass p-6 md:p-8 relative overflow-visible"
       data-controller="log-form"
       data-log-form-passage-id-value="<%= @passage.id %>">
    <div class="pointer-events-none absolute -top-24 -right-24 size-80 rounded-full
                bg-gradient-to-tr from-amber-200/40 to-rose-200/40 blur-3xl"></div>

    <h1 class="text-2xl md:text-3xl font-extrabold gh-underline mb-4">思考ログを追加</h1>

    <!-- passage メタ（文脈の想起） -->
    <% if @passage.title.present? || @passage.author.present? %>
      <div class="text-xs opacity-70 mb-4">
        対象: <%= [@passage.author, @passage.title.presence&.then { "『#{_1}』" }].compact.join(" ") %>
      </div>
    <% end %>

    <%= form_with model: [@passage, @thought_log],
                  local: true,
                  data: { action: "turbo:submit-end->log-form#submitted" },
                  class: "space-y-4",
                  html: { data: { "log-form-target": "form" } } do |f| %>

      <% if @thought_log.errors.any? %>
        <div class="alert alert-error">
          <span>入力にエラーがあるよ（<%= @thought_log.errors.count %>件）</span>
          <ul class="list-disc pl-5">
            <% @thought_log.errors.full_messages.each do |m| %>
              <li><%= m %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <!-- ツールバー -->
      <div class="flex flex-wrap gap-2">
        <button type="button" class="btn btn-xs" data-action="log-form#toolbar"
                data-log-form-type-param="bold">太字</button>
        <button type="button" class="btn btn-xs" data-action="log-form#toolbar"
                data-log-form-type-param="italic">斜体</button>
        <button type="button" class="btn btn-xs" data-action="log-form#toolbar"
                data-log-form-type-param="list">箇条書き</button>
        <button type="button" class="btn btn-xs" data-action="log-form#toolbar"
                data-log-form-type-param="todo">TODO</button>
        <button type="button" class="btn btn-xs" data-action="log-form#toolbar"
                data-log-form-type-param="quote">引用</button>

        <span class="opacity-50">|</span>

        <!-- 書き出しチップ -->
        <% chips = [
          "なぜ心に残った？",
          "どんな状況・気分で読んだ？",
          "一言で要約すると？",
          "今後の自分にどう効きそう？",
          "これから試す小さな一歩は？"
        ] %>
        <% chips.each do |t| %>
          <button type="button" class="btn btn-ghost btn-xs"
                  title="本文に挿入"
                  data-action="log-form#insertAtCursor"
                  data-log-form-text-param="■ <%= t %>"><%= t %></button>
        <% end %>

        <span class="opacity-50">|</span>

        <!-- 気分チップ -->
        <% %w(🙂 😌 🤔 😮 😢 🔥).each do |emo| %>
          <button type="button" class="btn btn-ghost btn-xs"
                  data-action="log-form#insertAtCursor"
                  data-log-form-text-param="<%= emo %> "><%= emo %></button>
        <% end %>
      </div>

      <!-- 本文＋プレビュー -->
      <div class="grid gap-4 md:grid-cols-2">
        <div>
          <%= f.label :content, "思考ログ", class: "block font-semibold mb-1" %>
          <%= f.text_area :content,
                rows: 10,
                class: "textarea textarea-bordered w-full",
                data: { "log-form-target": "textarea", action: "input->log-form#input" } %>
          <div class="mt-1 text-xs opacity-70" data-log-form-target="counter"></div>
          <p class="text-[11px] opacity-60 mt-1">⌘(Ctrl)+Enter で保存</p>
        </div>

        <div class="rounded-xl gh-glass p-3">
          <div class="text-xs opacity-70 mb-1">プレビュー（保存前）</div>
          <div class="text-sm leading-relaxed whitespace-normal"
               data-log-form-target="preview"></div>
        </div>
      </div>

      <div class="flex gap-2">
        <%= f.submit "保存する", class: "btn btn-primary" %>
        <%= link_to "キャンセル", passage_path(@passage), class: "btn btn-ghost" %>
      </div>
    <% end %>
  </div>
</div>
