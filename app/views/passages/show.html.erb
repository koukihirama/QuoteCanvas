<!-- 背景：空＋丘＋粒子 -->
<div class="fixed inset-0 -z-10 gh-sky">
  <div class="absolute inset-0 gh-hills opacity-70"></div>
  <div class="absolute inset-0 gh-grain pointer-events-none"></div>
</div>

<div class="container mx-auto max-w-7xl px-4 md:px-8 py-8 md:py-12">
  <div class="mb-6">
    <%= link_to "← 戻る", (request.referer || root_path), class: "link link-primary" %>
  </div>

  <%# --- 安全なフォールバック（@style が無い場合でも実効値を計算） --- %>
  <% style = @style || {
       bg:   @passage.customization&.bg_color.presence || @passage.bg_color.presence    || "#F9FAFB",
       text: @passage.customization&.color.presence    || @passage.text_color.presence  || "#111827",
       font: @passage.customization&.font.presence     || @passage.font_family.presence || "var(--font-serif)"
     } %>

  <div class="rounded-3xl gh-glass p-6 md:p-8 relative overflow-visible md:overflow-visible">
    <div class="pointer-events-none absolute -top-24 -right-24 size-80 rounded-full bg-gradient-to-tr from-amber-200/40 to-rose-200/40 blur-3xl"></div>

    <div class="grid gap-6 md:grid-cols-2 items-start">
      <!-- カード本体 -->
      <div class="relative rounded-2xl p-6 border card-lift"
           style="background:<%= style[:bg] %>;
                  color:<%= style[:text] %>;
                  font-family:<%= style[:font] %>;">
        <div class="absolute inset-0 gh-grain pointer-events-none rounded-2xl"></div>

        <% if @passage.title.present? || @passage.author.present? %>
          <div class="text-[11px] opacity-70 mb-1 font-sans">
            <%= [@passage.author, @passage.title.presence&.yield_self { |t| "『#{t}』" }].compact.join(" ") %>
          </div>
        <% end %>

        <div class="text-lg md:text-2xl font-semibold leading-relaxed">
          <%= simple_format(h(@passage.content)) %>
        </div>
      </div>

      <!-- メタ情報 -->
      <div class="space-y-4">
        <h1 class="text-2xl md:text-3xl font-bold gh-underline">一節の詳細</h1>

        <div class="rounded-2xl gh-glass p-5">
          <dl class="grid grid-cols-3 gap-3 text-sm">
            <dt class="opacity-70">著者</dt>
            <dd class="col-span-2"><%= @passage.author.presence || "-" %></dd>

            <dt class="opacity-70">タイトル</dt>
            <dd class="col-span-2"><%= @passage.title.presence || "-" %></dd>

            <dt class="opacity-70">作成</dt>
            <dd class="col-span-2"><%= l @passage.created_at, format: :long %></dd>

            <dt class="opacity-70">背景色</dt>
            <dd class="col-span-2">
              <code><%= style[:bg] %></code>
              <% if @passage.customization&.bg_color.present? %>
                <span class="badge badge-ghost ml-2">custom</span>
              <% end %>
            </dd>

            <dt class="opacity-70">文字色</dt>
            <dd class="col-span-2">
              <code><%= style[:text] %></code>
              <% if @passage.customization&.color.present? %>
                <span class="badge badge-ghost ml-2">custom</span>
              <% end %>
            </dd>

            <dt class="opacity-70">フォント</dt>
            <dd class="col-span-2">
              <code><%= style[:font] %></code>
              <% if @passage.customization&.font.present? %>
                <span class="badge badge-ghost ml-2">custom</span>
              <% end %>
            </dd>
          </dl>
        </div>

        <% if @passage.book_info.present? %>
  <% b = @passage.book_info %>

<section class="mt-6">
  <h2 class="text-xl md:text-2xl font-bold gh-underline mb-2">書誌情報</h2>

  <div class="rounded-2xl gh-glass p-5">
    <div class="flex gap-4 items-start">
      <%# カバー画像 or プレースホルダ %>
      <% if b&.cover_url.present? %>
        <%= image_tag b.cover_url, alt: (b.title.presence || "Book cover"),
              class: "w-16 h-24 object-cover rounded", loading: "lazy", decoding: "async" %>
      <% else %>
        <div class="w-16 h-24 rounded bg-base-200 grid place-items-center text-[10px] opacity-60">
          No Cover
        </div>
      <% end %>

      <div class="flex-1 min-w-0">
        <div class="font-semibold truncate"><%= b&.title.presence || "(書名未設定)" %></div>
        <div class="opacity-70 text-sm truncate"><%= b&.author.presence || "-" %></div>

        <dl class="grid grid-cols-3 gap-y-1 gap-x-3 text-[13px] mt-2">
          <dt class="opacity-70">出版社</dt>
          <dd class="col-span-2 break-words"><%= b&.publisher.presence || "-" %></dd>

          <dt class="opacity-70">出版日</dt>
          <dd class="col-span-2">
            <%= b&.published_date ? time_tag(b.published_date, b.published_date.to_s, datetime: b.published_date.iso8601) : "-" %>
          </dd>

          <dt class="opacity-70">ISBN</dt>
          <dd class="col-span-2">
            <% isbn = b&.isbn.to_s.strip.presence %>
            <% if isbn %>
              <code><%= isbn %></code>
              <button type="button" class="btn btn-ghost btn-xs ml-2" data-copy-isbn="<%= isbn %>">コピー</button>
            <% else %>
              -
            <% end %>
          </dd>

          <dt class="opacity-70">ページ数</dt>
          <dd class="col-span-2"><%= (b&.page_count.present? && b.page_count > 0) ? b.page_count : "-" %></dd>

          <dt class="opacity-70">提供元</dt>
          <dd class="col-span-2 flex items-center gap-2">
            <span class="badge badge-ghost"><%= b&.source.presence || "未設定" %></span>
            <% ext_url =
                 if b&.source == "google_books" && b&.source_id.present?
                   "https://books.google.com/books?id=#{ERB::Util.url_encode(b.source_id)}"
                 elsif b&.source == "open_library" && b&.source_id.present?
                   "https://openlibrary.org#{b.source_id}"
                 end %>
            <% if ext_url.present? %>
              <%= link_to "外部ページを開く", ext_url, class: "link link-primary text-xs",
                    target: "_blank", rel: "noopener noreferrer" %>
            <% end %>
          </dd>
        </dl>

        <%# 追加入力導線（未設定時のガイド） %>
        <% unless b %>
          <div class="mt-3">
            <%= link_to "書誌情報を追加する", edit_passage_path(@passage, open: "book_search"),
                  class: "btn btn-outline btn-sm" %>
            <p class="text-xs opacity-70 mt-1">編集画面で「🔎 書籍を検索してセット」を押してね</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</section>

<script>
(function attachCopyOnce(){
  if (window.__isbnCopyBound) return;
  window.__isbnCopyBound = true;
  document.addEventListener("click", (e) => {
    const btn = e.target.closest("[data-copy-isbn]");
    if (!btn) return;
    const v = btn.getAttribute("data-copy-isbn") || "";
    if (!v) return;
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(v);
    } else {
      const ta = document.createElement("textarea");
      ta.value = v; document.body.appendChild(ta);
      ta.select(); document.execCommand("copy"); ta.remove();
    }
    btn.classList.add("btn-success"); btn.textContent = "コピーしたよ";
    setTimeout(() => { btn.classList.remove("btn-success"); btn.textContent = "コピー"; }, 1200);
  });
})();
</script>

  <script>
    // ISBN コピー（必要なときだけ実行）
    document.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-copy-isbn]");
      if (!btn) return;
      const v = btn.getAttribute("data-copy-isbn");
      if (!navigator.clipboard) {
        // フォールバック（ごく簡易）
        const ta = document.createElement("textarea");
        ta.value = v; document.body.appendChild(ta);
        ta.select(); document.execCommand("copy"); ta.remove();
      } else {
        navigator.clipboard.writeText(v);
      }
      btn.classList.add("btn-success");
      btn.textContent = "コピーしたよ";
      setTimeout(() => {
        btn.classList.remove("btn-success");
        btn.textContent = "コピー";
      }, 1200);
    });
  </script>
<% end %>


        <!-- 思考ログ：この一節に紐づく“考えの連鎖” -->
        <section class="mt-6">
          <div class="flex items-end justify-between">
            <div>
              <h2 class="text-xl md:text-2xl font-bold gh-underline">思考ログ</h2>
              <p class="opacity-70 text-sm mt-1"><%= @thought_logs&.size || 0 %> 件</p>
            </div>

            <% if user_signed_in? && @passage.user_id == current_user.id %>
              <div class="flex gap-2">
                <%= link_to "＋ 思考ログを追加",
                            new_passage_thought_log_path(@passage),
                            class: "btn btn-outline btn-press" %>

                <% if @passage.customization.present? %>
                  <%= link_to "見た目をカスタマイズ",
                              edit_passage_customization_path(@passage),
                              class: "btn btn-ghost btn-press" %>
                <% else %>
                  <%= link_to "見た目をカスタマイズ",
                              new_passage_customization_path(@passage),
                              class: "btn btn-ghost btn-press" %>
                <% end %>
              </div>
            <% end %>
          </div>

          <% if @thought_logs.present? %>
            <div class="mt-4 space-y-3">
              <% @thought_logs.each do |log| %>
                <article class="rounded-2xl gh-glass p-4 hover-float">
                  <div class="flex items-center justify-between text-xs opacity-70 mb-2">
                    <span>記録日時</span>
                    <time datetime="<%= log.created_at.iso8601 %>"><%= l log.created_at, format: :long %></time>
                  </div>
                  <div class="leading-relaxed text-sm whitespace-pre-wrap">
                    <%= h(log.content) %>
                  </div>
                </article>
              <% end %>
            </div>
          <% else %>
            <div class="mt-4 rounded-2xl gh-glass p-6 text-center hover-float">
              <p class="font-semibold">まだ思考ログはありません</p>
              <p class="opacity-70 text-sm mt-1">この一節から連想した気づきや感情を残しておこう。</p>
              <% if user_signed_in? && @passage.user_id == current_user.id %>
                <div class="mt-4">
                  <%= link_to "＋ 最初の思考ログを追加",
                              new_passage_thought_log_path(@passage),
                              class: "btn btn-primary btn-press" %>
                </div>
              <% end %>
            </div>
          <% end %>
        </section>

        <!-- 下部のアクション群 -->
        <div class="flex flex-wrap gap-2">
          <% if user_signed_in? && @passage.user_id == current_user.id %>
            <%= link_to "編集", edit_passage_path(@passage), class: "btn btn-outline btn-press" %>

            <%# カスタマイズ導線（下部にも設置） %>
            <% if @passage.customization.present? %>
              <%= link_to "見た目をカスタマイズ",
                          edit_passage_customization_path(@passage),
                          class: "btn btn-ghost btn-press" %>
            <% else %>
              <%= link_to "見た目をカスタマイズ",
                          new_passage_customization_path(@passage),
                          class: "btn btn-ghost btn-press" %>
            <% end %>

            <%= link_to "削除", passage_path(@passage),
                  data: { turbo_method: :delete, turbo_confirm: "本当に削除しますか？" },
                  class: "btn btn-error btn-press" %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>