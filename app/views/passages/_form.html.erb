<%# ====== è‰²ãƒ»ãƒ•ã‚©ãƒ³ãƒˆã®åˆæœŸã‚¹ã‚¿ã‚¤ãƒ« ====== %>
<% style_bg   = passage.customization&.bg_color.presence   || passage.bg_color.presence    || "#F9FAFB" %>
<% style_text = passage.customization&.color.presence      || passage.text_color.presence  || "#111827" %>
<% style_font = passage.customization&.font.presence       || passage.font_family.presence || "var(--font-serif)" %>

<%= form_with model: passage,
      local: true,
      html: {
        id: "passage-form",
        autocomplete: "off",
        data: {
          controller: "book-search",
          action: "submit->book-search#mirrorToHidden turbo:submit-start->book-search#mirrorToHidden"
        }
      },
      class: "space-y-6" do |f| %>

  <%= render "shared/form_errors", object: f.object %>

  <%# ====== 2ã‚«ãƒ©ãƒ ï¼ˆmdä»¥ä¸Šã§åˆ†å‰² / ã‚¹ãƒãƒ›ã¯1ã‚«ãƒ©ãƒ ï¼‰ ====== %>
  <div class="grid gap-6 md:grid-cols-2 items-start">
    <%# ================= å·¦ï¼šå…¥åŠ›ã‚«ãƒ©ãƒ  ================= %>
    <div class="space-y-6">
      <!-- æœ¬æ–‡ -->
      <div>
        <%= f.label :content, "ä¸€ç¯€æœ¬æ–‡", class: "block font-semibold mb-1" %>
        <%= f.text_area :content, rows: 5,
              class: "textarea textarea-bordered w-full",
              data: { preview_target: "content" } %>
      </div>

      <!-- ã‚¿ã‚¤ãƒˆãƒ« / è‘—è€… -->
      <div class="grid gap-4 md:grid-cols-2">
        <div>
          <%= f.label :title, "ä½œå“ã‚¿ã‚¤ãƒˆãƒ«", class: "block font-semibold mb-1" %>
          <%= f.text_field :title,
                class: "input input-bordered w-full",
                data: {
                  preview_target: "title",
                  action: "input->book-search#trySuggest",
                  "book-search-target": "title"
                } %>
        </div>
        <div>
          <%= f.label :author, "è‘—è€…", class: "block font-semibold mb-1" %>
          <%= f.text_field :author,
                class: "input input-bordered w-full",
                data: {
                  preview_target: "author",
                  action: "input->book-search#trySuggest",
                  "book-search-target": "author"
                } %>
        </div>
      </div>

      <!-- æ›¸ç±æ¤œç´¢ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ã‚¯ãƒªã‚¢ï¼‰ï¼‹ ISBN -->
      <div class="flex flex-col gap-2">
        <div class="flex gap-2">
          <button type="button"
                  class="btn btn-outline btn-sm"
                  data-action="click->book-search#open">ğŸ” æ›¸ç±ã‚’æ¤œç´¢ã—ã¦ã‚»ãƒƒãƒˆ</button>
          <button type="button"
                  class="btn btn-ghost btn-sm"
                  data-action="click->book-search#clear">ã‚¯ãƒªã‚¢</button>
        </div>

        <div class="max-w-xs">
          <label class="label"><span class="label-text text-xs">ISBNï¼ˆä»»æ„ã€‚å…¥åŠ›ã§å€™è£œè¡¨ç¤ºï¼‰</span></label>
          <%= f.fields_for :book_info do |bf| %>
            <%= bf.text_field :isbn,
                  class: "input input-bordered w-full",
                  placeholder: "9784041026229",
                  data: { action: "input->book-search#trySuggest",
                          "book-search-target": "isbn" } %>
          <% end %>
        </div>
      </div>

      <%# ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å€™è£œè¡¨ç¤º %>
      <div class="mt-2" data-book-search-target="inlineResults"></div>

      <!-- è¦‹ãŸç›®ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºï¼ˆç°¡æ˜“ï¼‰ -->
      <details class="collapse collapse-arrow bg-base-200 mt-2">
        <summary class="collapse-title font-semibold">è¦‹ãŸç›®ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºï¼ˆç°¡æ˜“ï¼‰</summary>
        <div class="collapse-content grid gap-4 md:grid-cols-3">
          <%= f.fields_for :customization do |c| %>
            <%= c.hidden_field :id if c.object&.persisted? %>

            <!-- ãƒ•ã‚©ãƒ³ãƒˆ -->
            <div>
              <%= c.label :font, "ãƒ•ã‚©ãƒ³ãƒˆ", class: "block font-semibold mb-1" %>
              <div class="flex gap-2 mb-2">
                <% [["Serif","var(--font-serif)"],["Sans","var(--font-sans)"],["Mono","var(--font-mono)"]].each do |label, val| %>
                  <button type="button" class="btn btn-xs" data-quick-font="<%= val %>"><%= label %></button>
                <% end %>
              </div>
              <%= c.select :font,
                    options_for_select([
                      ["æ¨™æº–ï¼ˆSerifï¼‰", "var(--font-serif)"],
                      ["æ¨™æº–ï¼ˆSansï¼‰",  "var(--font-sans)"],
                      ["ç­‰å¹…ï¼ˆMonoï¼‰",  "var(--font-mono)"]
                    ], c.object&.font),
                    { include_blank: "ï¼ˆæœªé¸æŠ = æ—¢å®šï¼‰" },
                    class: "select select-bordered w-full",
                    data: { preview_target: "font" } %>
            </div>

            <!-- æ–‡å­—è‰² -->
            <div>
              <%= c.label :color, "æ–‡å­—è‰² (#RRGGBB / #RGB)", class: "block font-semibold mb-1" %>
              <div class="flex items-center gap-2">
                <%= c.text_field :color,
                      class: "input input-bordered w-full",
                      placeholder: "#111827",
                      pattern: "#(?:[0-9a-fA-F]{3}|[0-9a-fA-F]{6})",
                      title: "#RRGGBB å½¢å¼ã§å…¥åŠ›ã—ã¦ã­ï¼ˆä¾‹: #111827ï¼‰",
                      data: { preview_target: "textColor" } %>
                <input type="color" class="input w-12 p-0"
                       value="<%= (c.object&.color.presence || passage.customization&.color.presence || passage.text_color.presence || '#111827') %>"
                       data-colorpicker="textColor" />
              </div>
              <div class="flex flex-wrap gap-2 mt-2">
                <% [["#111827","æ¿ƒã„ã‚°ãƒ¬ãƒ¼"],["#1F2937","Gray-800"],["#374151","Gray-700"],["#000000","Black"]].each do |hex, name| %>
                  <button type="button" class="btn btn-xs" title="<%= name %>"
                          data-color-preset="textColor" data-value="<%= hex %>">
                    <span class="inline-block size-3 rounded-full mr-1" style="background:<%= hex %>"></span><%= name %>
                  </button>
                <% end %>
                <button type="button" class="btn btn-xs" data-clear-color="textColor">æœªæŒ‡å®šã«æˆ»ã™</button>
                <button type="button" class="btn btn-xs" data-pick-current="textColor">ç¾åœ¨è‰²ã‚’æ‹¾ã†</button>
              </div>
              <div class="flex items-center gap-2 mt-2">
                <span class="badge">HEX</span>
                <div class="flex gap-1" data-recent="textColor"></div>
              </div>
            </div>

            <!-- èƒŒæ™¯è‰² -->
            <div>
              <%= c.label :bg_color, "èƒŒæ™¯è‰² (#RRGGBB / #RGB)", class: "block font-semibold mb-1" %>
              <div class="flex items-center gap-2">
                <%= c.text_field :bg_color,
                      class: "input input-bordered w-full",
                      placeholder: "#F9FAFB",
                      pattern: "#(?:[0-9a-fA-F]{3}|[0-9a-fA-F]{6})",
                      title: "#RRGGBB å½¢å¼ã§å…¥åŠ›ã—ã¦ã­ï¼ˆä¾‹: #F9FAFBï¼‰",
                      data: { preview_target: "bgColor" } %>
                <input type="color" class="input w-12 p-0"
                       value="<%= (c.object&.bg_color.presence || passage.customization&.bg_color.presence || passage.bg_color.presence || '#F9FAFB') %>"
                       data-colorpicker="bgColor" />
              </div>
              <div class="flex flex-wrap gap-2 mt-2">
                <% [["#F9FAFB","ã»ã¼ç™½"],["#F3F4F6","Gray-100"],["#E5E7EB","Gray-200"],["#FFFFFF","White"]].each do |hex, name| %>
                  <button type="button" class="btn btn-xs" title="<%= name %>"
                          data-color-preset="bgColor" data-value="<%= hex %>">
                    <span class="inline-block size-3 rounded-full mr-1 border" style="background:<%= hex %>"></span><%= name %>
                  </button>
                <% end %>
                <button type="button" class="btn btn-xs" data-clear-color="bgColor">æœªæŒ‡å®šã«æˆ»ã™</button>
                <button type="button" class="btn btn-xs" data-pick-current="bgColor">ç¾åœ¨è‰²ã‚’æ‹¾ã†</button>
              </div>
              <div class="flex items-center gap-2 mt-2">
                <span class="badge">HEX</span>
                <div class="flex gap-1" data-recent="bgColor"></div>
              </div>
            </div>
          <% end %>
        </div>
      </details>

      <!-- BookInfoï¼ˆä¿å­˜ç”¨ hidden ã¨å…¬é–‹ã—ãŸã„é …ç›®ï¼‰ -->
      <%= f.fields_for :book_info do |bf| %>
        <%= bf.hidden_field :id if bf.object&.persisted? %>
        <%= bf.hidden_field :title,          data: { "book-search-target": "title" } %>
        <%= bf.hidden_field :author,         data: { "book-search-target": "author" } %>
        <%= bf.hidden_field :published_date, data: { "book-search-target": "publishedDate" } %>
        <%= bf.hidden_field :cover_url,      data: { "book-search-target": "coverUrl" } %>
        <%= bf.hidden_field :publisher,      data: { "book-search-target": "publisher" } %>
        <%= bf.hidden_field :page_count,     data: { "book-search-target": "pageCount" } %>
        <%= bf.hidden_field :source,         data: { "book-search-target": "source" } %>
        <%= bf.hidden_field :source_id,      data: { "book-search-target": "sourceId" } %>
      <% end %>

      <!-- è©³ç´°è¨­å®šãƒšãƒ¼ã‚¸ã¸ã®å°ç·š -->
      <div class="mt-2">
        <% if passage.persisted? %>
          <% if passage.customization.present? %>
            <%= link_to "è¦‹ãŸç›®ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºï¼ˆè©³ç´°è¨­å®šï¼‰", edit_passage_customization_path(passage), class: "btn btn-outline" %>
          <% else %>
            <%= link_to "è¦‹ãŸç›®ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºï¼ˆè©³ç´°è¨­å®šï¼‰", new_passage_customization_path(passage), class: "btn btn-outline" %>
          <% end %>
        <% else %>
          <button class="btn btn-outline" disabled>è¦‹ãŸç›®ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºï¼ˆè©³ç´°è¨­å®šï¼‰</button>
          <p class="text-xs opacity-70 mt-1">â€» ã¾ãšæœ¬æ–‡ã‚’ä¿å­˜ã—ã¦ã‹ã‚‰è©³ç´°ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã‚‹ã‚ˆ</p>
        <% end %>
      </div>

      <!-- é€ä¿¡ãƒœã‚¿ãƒ³ -->
      <div class="flex gap-2">
        <%= f.submit (passage.persisted? ? "æ›´æ–°ã™ã‚‹" : "ä¿å­˜ã™ã‚‹"), class: "btn btn-primary" %>
        <%= link_to "ã‚­ãƒ£ãƒ³ã‚»ãƒ«",
              (passage.persisted? ? passage_path(passage) : dashboard_path),
              class: "btn btn-ghost" %>
      </div>
    </div>

    <%# ================= å³ï¼šPCç”¨ sticky ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ ================= %>
    <aside class="hidden md:block md:sticky md:top-24">
      <div class="mb-2">
        <h2 class="text-xl font-bold gh-underline">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
        <p class="text-sm opacity-70">å…¥åŠ›ã«åˆã‚ã›ã¦è‡ªå‹•æ›´æ–°</p>
      </div>

      <div id="preview-card-desktop"
           class="relative rounded-2xl p-6 border gh-glass"
           style="background:<%= style_bg %>; color:<%= style_text %>; font-family:<%= style_font %>;">
        <div class="absolute inset-0 gh-grain pointer-events-none rounded-2xl"></div>
        <div id="preview-meta-desktop" class="text-[11px] opacity-70 mb-1 font-sans">
          <% meta = [f.object.author.presence, f.object.title.presence&.yield_self { |t| "ã€#{t}ã€" }].compact.join(" ") %>
          <%= meta %>
        </div>
        <div id="preview-content-desktop" class="text-lg md:text-2xl font-semibold leading-relaxed whitespace-pre-wrap"></div>
      </div>
    </aside>
  </div> <!-- /grid -->
<% end %>

<%# ====== ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ï¼šè¿½å¾“ãƒŸãƒ‹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ FABï¼ˆå³ä¸‹ã«å‡ºãŸã‚Šæ¶ˆãˆãŸã‚Šï¼‰ ====== %>
<div id="preview-fab" class="hidden md:block fixed bottom-6 right-6 z-40 opacity-0 pointer-events-none transition-opacity duration-200">
  <div id="preview-card-fab"
       class="relative rounded-xl border gh-glass p-4 qc-fab shadow-xl"
       style="background:<%= style_bg %>; color:<%= style_text %>; font-family:<%= style_font %>;">
    <div class="absolute inset-0 gh-grain pointer-events-none rounded-xl"></div>
    <div id="preview-meta-fab" class="text-[10px] opacity-70 mb-1 font-sans"></div>
    <div id="preview-content-fab" class="text-sm font-semibold leading-snug clamp-3"></div>
  </div>
</div>

<%# ====== ãƒ¢ãƒã‚¤ãƒ«ç”¨ï¼šä¸‹å›ºå®šãƒŸãƒ‹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ ====== %>
<div class="md:hidden fixed inset-x-0 bottom-0 z-40">
  <div class="mx-auto max-w-7xl px-4" style="padding-bottom: env(safe-area-inset-bottom);">
    <div class="rounded-xl border gh-glass p-3 shadow-lg backdrop-blur">
      <div id="preview-card-mobile"
           class="rounded-lg p-3"
           style="background:<%= style_bg %>; color:<%= style_text %>; font-family:<%= style_font %>; max-height: 28vh; overflow:auto;">
        <div class="text-[10px] opacity-70 mb-1 font-sans" id="preview-meta-mobile"></div>
        <div class="text-base font-semibold leading-relaxed whitespace-pre-wrap" id="preview-content-mobile"></div>
      </div>
      <div class="mt-2 flex justify-end">
        <button type="button" class="btn btn-xs" id="toggle-mobile-preview">å±•é–‹/åç´</button>
      </div>
    </div>
  </div>
</div>
<div class="h-28 md:hidden"></div>

<%# ====== æ›¸ç±æ¤œç´¢ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãã®ã¾ã¾ï¼‰ ====== %>
<dialog id="book-search-modal" class="modal">
  <div class="modal-box max-w-3xl">
    <h3 class="font-bold text-lg mb-4">æ›¸ç±æ¤œç´¢</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-3">
      <input type="text" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" class="input input-bordered w-full" data-book-search-target="qTitle">
      <input type="text" placeholder="è‘—è€…"     class="input input-bordered w-full" data-book-search-target="qAuthor">
      <input type="text" placeholder="ISBN"     class="input input-bordered w-full" data-book-search-target="qIsbn">
    </div>
    <div class="flex gap-2 mb-4">
      <button class="btn btn-primary btn-sm" data-action="click->book-search#search">æ¤œç´¢</button>
      <button class="btn btn-ghost btn-sm"   data-action="click->book-search#close">é–‰ã˜ã‚‹</button>
    </div>
    <div class="overflow-y-auto max-h-[45vh]">
      <ul class="menu w-full" data-book-search-target="results"></ul>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop" data-action="click->book-search#close">
    <button>close</button>
  </form>
</dialog>

<%# ====== è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆFABã‚µã‚¤ã‚ºï¼†ã‚¯ãƒ©ãƒ³ãƒ—ï¼‰ ====== %>
<style nonce="<%= content_security_policy_nonce %>">
  .qc-fab{ box-sizing:border-box; width: 320px; max-width: calc(100vw - 24px); height: 132px; }
  @media (max-width: 1200px){ .qc-fab{ width: 300px; height: 124px; } }
  .clamp-3{-webkit-line-clamp:3;display:-webkit-box;-webkit-box-orient:vertical;overflow:hidden}
</style>

<%# ====== ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼åæ˜  + â€œè¦‹å¤±ã£ãŸã‚‰FABâ€è¡¨ç¤ºåˆ¶å¾¡ ====== %>
<script nonce="<%= content_security_policy_nonce %>">
(function(){
  function setupPreview(){
    const form = document.getElementById("passage-form") || document.querySelector("form");
    if (!form || form.dataset.previewBound === "1") return;
    form.dataset.previewBound = "1";

    // å…¥åŠ›
    const title   = form.querySelector('[data-preview-target="title"]');
    const author  = form.querySelector('[data-preview-target="author"]');
    const body    = form.querySelector('[data-preview-target="content"]');
    const fontSel = form.querySelector('[data-preview-target="font"]');
    const textInp = form.querySelector('[data-preview-target="textColor"]');
    const bgInp   = form.querySelector('[data-preview-target="bgColor"]');
    const textPick= form.querySelector('input[data-colorpicker="textColor"]');
    const bgPick  = form.querySelector('input[data-colorpicker="bgColor"]');

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦ç´ ï¼ˆPC / Mobile / FABï¼‰
    const cardD = document.getElementById('preview-card-desktop');
    const metaD = document.getElementById('preview-meta-desktop');
    const contD = document.getElementById('preview-content-desktop');

    const cardM = document.getElementById('preview-card-mobile');
    const metaM = document.getElementById('preview-meta-mobile');
    const contM = document.getElementById('preview-content-mobile');

    const fabWrap = document.getElementById('preview-fab');
    const cardF = document.getElementById('preview-card-fab');
    const metaF = document.getElementById('preview-meta-fab');
    const contF = document.getElementById('preview-content-fab');

    const anyCard = cardD || cardM || cardF;
    const FALLBACK = {
      font: (anyCard && anyCard.style.fontFamily) || "var(--font-serif)",
      text: (anyCard && anyCard.style.color)      || "#111827",
      bg:   (anyCard && anyCard.style.background) || "#F9FAFB"
    };

    function setCardStyle(el){
      if (!el) return;
      el.style.fontFamily = (fontSel && fontSel.value.trim()) || FALLBACK.font;
      el.style.color      = (textInp && textInp.value.trim()) || FALLBACK.text;
      el.style.background = (bgInp   && bgInp.value.trim())   || FALLBACK.bg;
    }
    function updateMeta(){
      const a = (author?.value || "").trim();
      const t = (title?.value  || "").trim();
      const meta = [a, t ? `ã€${t}ã€` : null].filter(Boolean).join(" ");
      if (metaD) metaD.textContent = meta;
      if (metaM) metaM.textContent = meta;
      if (metaF) metaF.textContent = meta;
    }
    function updateBody(){
      const v = (body?.value || "");
      if (contD) contD.textContent = v;
      if (contM) contM.textContent = v;
      if (contF) contF.textContent = v;
    }
    function applyStyleAll(){ setCardStyle(cardD); setCardStyle(cardM); setCardStyle(cardF); }

    function bindPair(textInput, colorInput){
      if (!textInput || !colorInput) return;
      colorInput.addEventListener("input", e => { textInput.value = e.target.value; applyStyleAll(); });
      textInput.addEventListener("input", e => { if (/^#/.test(e.target.value)) colorInput.value = e.target.value; applyStyleAll(); });
    }

    // ã‚¯ã‚¤ãƒƒã‚¯ãƒ•ã‚©ãƒ³ãƒˆ
    form.querySelectorAll('[data-quick-font]').forEach(btn => {
      btn.addEventListener("click", () => {
        if (!fontSel) return;
        fontSel.value = btn.dataset.quickFont;
        fontSel.dispatchEvent(new Event("change", { bubbles: true }));
      });
    });

    // æœ€è¿‘è‰²ã®ç¶­æŒï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼‰
    function rgbToHex(rgb){ const m = rgb.match(/\d+/g); if(!m) return ""; return "#" + m.slice(0,3).map(n => ("0"+parseInt(n,10).toString(16)).slice(-2)).join(""); }
    function saveRecent(inputEl, hex){
      if (!hex || !hex.startsWith("#")) return;
      const key = inputEl === textInp ? "recent_text" : "recent_bg";
      const arr = JSON.parse(localStorage.getItem(key) || "[]").filter(v => v !== hex);
      arr.unshift(hex); localStorage.setItem(key, JSON.stringify(arr.slice(0,8)));
      renderRecent();
    }
    function renderRecent(){
      const wrapText = form.querySelector('[data-recent="textColor"]');
      const wrapBg   = form.querySelector('[data-recent="bgColor"]');
      const make = (hex, key) => {
        const b = document.createElement("button");
        b.type = "button"; b.title = hex;
        b.className = "size-6 rounded-full border";
        b.style.background = hex;
        b.addEventListener("click", () => {
          const inp = key === "textColor" ? textInp : bgInp;
          const pick= key === "textColor" ? textPick : bgPick;
          if (inp)  inp.value = hex;
          if (pick) pick.value = hex;
          applyStyleAll(); saveRecent(inp, hex);
        });
        return b;
      };
      if (wrapText){ wrapText.innerHTML = ""; (JSON.parse(localStorage.getItem("recent_text") || "[]")).forEach(hex => wrapText.appendChild(make(hex,"textColor"))); }
      if (wrapBg){   wrapBg.innerHTML = "";   (JSON.parse(localStorage.getItem("recent_bg")   || "[]")).forEach(hex => wrapBg.appendChild(make(hex,"bgColor"))); }
    }

    form.querySelectorAll('[data-color-preset]').forEach(btn => {
      btn.addEventListener("click", (e) => {
        const key = e.currentTarget.dataset.colorPreset;
        const val = e.currentTarget.dataset.value;
        const inp = key === "textColor" ? textInp : bgInp;
        const pick= key === "textColor" ? textPick : bgPick;
        if (inp)  inp.value = val;
        if (pick) pick.value = val;
        applyStyleAll(); saveRecent(inp, val);
      });
    });
    form.querySelectorAll('[data-clear-color]').forEach(btn => {
      btn.addEventListener("click", (e) => {
        const key = e.currentTarget.dataset.clearColor;
        const inp = key === "textColor" ? textInp : bgInp;
        if (inp) inp.value = ""; applyStyleAll();
      });
    });
    form.querySelectorAll('[data-pick-current]').forEach(btn => {
      btn.addEventListener("click", (e) => {
        const key = e.currentTarget.dataset.pickCurrent;
        const prop= key === "textColor" ? "color" : "backgroundColor";
        const source = cardD || cardM || cardF;
        const val = source ? rgbToHex(getComputedStyle(source)[prop]) : "";
        const inp = key === "textColor" ? textInp : bgInp;
        const pick= key === "textColor" ? textPick : bgPick;
        if (inp && val) inp.value = val;
        if (pick) pick.value = val;
        applyStyleAll(); saveRecent(inp, val);
      });
    });

    [title, author].forEach(el => el && el.addEventListener("input", updateMeta));
    body && body.addEventListener("input", updateBody);
    fontSel && fontSel.addEventListener("change", applyStyleAll);
    bindPair(textInp, textPick);
    bindPair(bgInp,   bgPick);

    // åˆæœŸè¡¨ç¤º
    updateMeta(); updateBody(); applyStyleAll(); renderRecent();

    // â˜… ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ï¼šå³ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¦–ç•Œã‹ã‚‰æ¶ˆãˆãŸã‚‰ FAB ã‚’è¡¨ç¤º
    if ('IntersectionObserver' in window && cardD && fabWrap){
      const io = new IntersectionObserver((entries) => {
        entries.forEach(e => {
          if (e.isIntersecting){
            fabWrap.classList.add('opacity-0','pointer-events-none');
            fabWrap.classList.remove('opacity-100');
          }else{
            fabWrap.classList.remove('opacity-0','pointer-events-none');
            fabWrap.classList.add('opacity-100');
          }
        });
      }, { root: null, threshold: 0.2 });
      io.observe(cardD);
    }

    // ãƒ¢ãƒã‚¤ãƒ«ï¼šå±•é–‹/åç´
    const toggleBtn = document.getElementById('toggle-mobile-preview');
    if (toggleBtn && cardM){
      let expanded = true;
      toggleBtn.addEventListener('click', () => {
        expanded = !expanded;
        cardM.style.maxHeight = expanded ? '28vh' : '10vh';
        cardM.style.overflow  = 'auto';
      });
    }
  }

  // Turbo å¯¾å¿œ
  document.addEventListener("turbo:load",   setupPreview);
  document.addEventListener("turbo:render", setupPreview);
  if (document.readyState !== "loading") setupPreview();
  else document.addEventListener("DOMContentLoaded", setupPreview);
})();
</script>
