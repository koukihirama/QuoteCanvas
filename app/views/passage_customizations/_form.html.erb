<%= form_with model: customization,
              url: url,
              local: true,
              html: { autocomplete: "off" },
              class: "space-y-6" do |f| %>

  <%= f.hidden_field :id if customization.persisted? %>

  <% if customization.errors.any? %>
    <div class="alert alert-error">
      <span>å…¥åŠ›ã«ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹ã‚ˆï¼ˆ<%= customization.errors.count %>ä»¶ï¼‰</span>
      <ul class="list-disc pl-5">
        <% customization.errors.full_messages.each do |m| %>
          <li><%= m %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="grid gap-6 md:grid-cols-2 items-start">
    <!-- â‘  ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆSPå…ˆé ­ / mdä»¥ä¸Šã¯å³å›ºå®šï¼‰ -->
    <div class="order-1 md:order-2 md:sticky md:top-24">
      <div id="preview-card"
           class="relative rounded-2xl p-6 border card-lift"
           style="background:<%= fallback[:bg] %>; color:<%= fallback[:text] %>; font-family:<%= fallback[:font] %>;"
           data-fallback-bg="<%= fallback[:bg] %>"
           data-fallback-text="<%= fallback[:text] %>"
           data-fallback-font="<%= fallback[:font] %>">
        <div class="absolute inset-0 gh-grain pointer-events-none rounded-2xl"></div>

        <% if passage.title.present? || passage.author.present? %>
          <div class="text-[11px] opacity-70 mb-1 font-sans">
            <%= [passage.author, passage.title.presence&.yield_self { |t| "ã€#{t}ã€" }].compact.join(" ") %>
          </div>
        <% end %>

        <div class="text-lg md:text-2xl font-semibold leading-relaxed">
          <%= simple_format(h(passage.content)) %>
        </div>
      </div>
    </div>

    <!-- â‘¡ å…¥åŠ›ï¼ˆSPå¾Œã‚ / mdä»¥ä¸Šã¯å·¦ï¼‰ -->
    <div class="order-2 md:order-1 space-y-5">
      <!-- ãƒ•ã‚©ãƒ³ãƒˆ -->
      <div>
        <%= f.label :font, "ãƒ•ã‚©ãƒ³ãƒˆ", class: "block font-semibold mb-1" %>
        <div class="flex gap-2 mb-2">
          <% [["Serif","var(--font-serif)"],["Sans","var(--font-sans)"],["Mono","var(--font-mono)"]].each do |label, val| %>
            <button type="button" class="btn btn-xs" data-quick-font="<%= val %>"><%= label %></button>
          <% end %>
        </div>
        <%= f.select :font,
              options_for_select([
                ["æ¨™æº–ï¼ˆSerifï¼‰", "var(--font-serif)"],
                ["æ¨™æº–ï¼ˆSansï¼‰",  "var(--font-sans)"],
                ["ç­‰å¹…ï¼ˆMonoï¼‰",  "var(--font-mono)"]
              ], customization.font),
              { include_blank: "ï¼ˆæœªé¸æŠ = æ—¢å®šï¼‰" },
              class: "select select-bordered w-full",
              data: { preview_target: "font" } %>
        <p class="text-xs opacity-70 mt-1">æœªé¸æŠãªã‚‰ã‚«ãƒ¼ãƒ‰æ—¢å®šã®ãƒ•ã‚©ãƒ³ãƒˆãŒä½¿ã‚ã‚Œã‚‹ã‚ˆã€‚</p>
      </div>

      <!-- æ–‡å­—è‰² -->
      <%= render "passage_customizations/color_field_with_palette",
            f: f,
            field: :color,
            label: "æ–‡å­—è‰²",
            key: "textColor",
            default_color: (customization.color.presence || fallback[:text]) %>

      <!-- èƒŒæ™¯è‰² -->
      <%= render "passage_customizations/color_field_with_palette",
            f: f,
            field: :bg_color,
            label: "èƒŒæ™¯è‰²",
            key: "bgColor",
            default_color: (customization.bg_color.presence || fallback[:bg]) %>

      <div class="flex gap-2">
        <%= f.submit submit_label, class: "btn btn-primary" %>
        <%= link_to "ã‚­ãƒ£ãƒ³ã‚»ãƒ«", passage_path(passage), class: "btn btn-ghost" %>
      </div>
    </div>
  </div>
<% end %>

<!-- â‘¢ SPå°‚ç”¨ï¼šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¸ã‚¸ãƒ£ãƒ³ãƒ—ã™ã‚‹FAB -->
<button id="jump-preview"
        class="md:hidden fixed bottom-4 right-4 btn btn-primary shadow-lg hidden"
        type="button" aria-label="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¸">
  ğŸ‘ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
</button>

<!-- â‘£ æœ€å°JSï¼šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å³æ™‚åæ˜ ï¼ˆStimulusé€£æºã‚’å‰æã«è¶…è»½é‡ï¼‰ -->
<script>
(() => {
  const root  = document.currentScript.closest("body") || document;
  const card  = root.querySelector("#preview-card");
  const font  = root.querySelector('[data-preview-target="font"]');
  const textI = root.querySelector('[data-preview-target="textColor"]');
  const bgI   = root.querySelector('[data-preview-target="bgColor"]');
  const fab   = root.querySelector("#jump-preview");

  const FALLBACK = {
    font: card?.dataset.fallbackFont || "var(--font-serif)",
    text: card?.dataset.fallbackText || "#111827",
    bg:   card?.dataset.fallbackBg   || "#F9FAFB",
  };

  const apply = () => {
    if (!card) return;
    card.style.fontFamily = (font?.value  || "").trim() || FALLBACK.font;
    card.style.color      = (textI?.value || "").trim() || FALLBACK.text;
    card.style.background = (bgI?.value   || "").trim() || FALLBACK.bg;
  };

  // ãƒ•ã‚©ãƒ³ãƒˆï¼šã‚¯ã‚¤ãƒƒã‚¯ãƒœã‚¿ãƒ³
  root.querySelectorAll('[data-quick-font]').forEach(btn => {
    btn.addEventListener("click", () => {
      if (!font) return;
      font.value = btn.dataset.quickFont;
      font.dispatchEvent(new Event("change", { bubbles: true }));
    });
  });

  // å…¥åŠ›ã®å¤‰åŒ–ã‚’ç›£è¦–ï¼ˆStimulusãŒ input/change ã‚’ç™ºç«ã—ã¦ãã‚Œã‚‹ï¼‰
  font?.addEventListener("change", apply);
  textI?.addEventListener("input",  apply);
  textI?.addEventListener("change", apply);
  bgI?.addEventListener("input",    apply);
  bgI?.addEventListener("change",   apply);

  // åˆæœŸåæ˜ 
  apply();

  // SPï¼šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒç”»é¢å¤–ã«å‡ºãŸã‚‰FABè¡¨ç¤º
  if (card && fab && "IntersectionObserver" in window) {
    const io = new IntersectionObserver(([ent]) => {
      fab.classList.toggle("hidden", ent.isIntersecting);
    }, { threshold: 0.1 });
    io.observe(card);
    fab.addEventListener("click", () => {
      card.scrollIntoView({ behavior: "smooth", block: "nearest" });
    });
  }
})();
</script>